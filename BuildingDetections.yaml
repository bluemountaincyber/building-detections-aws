AWSTemplateFormatVersion: 2010-09-09
Resources:
  SecurityHub:
    Type: 'AWS::SecurityHub::Hub'
  LambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: LambaSecurityHubPutFinding
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 'securityhub:BatchImportFindings'
                Resource: '*'
  HoneyFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: HoneyFileDetection
      Code:
        ZipFile: |
          import boto3
          from datetime import datetime

          def lambda_handler(event, context):
              # Get Account ID
              client = boto3.client('sts')
              response = client.get_caller_identity()
              acctId = response['Account']
              print(acctId)
    
              # Write finding
              timestamp = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S.%f')[:-3] + "Z"
              client = boto3.client('securityhub')
              client.batch_import_findings(
                  Findings = [{
                  "AwsAccountId": acctId,
                  "CreatedAt": event['detail']['eventTime'],
                  "Description": "Honey file used",
                  "GeneratorId": "custom",
                  "Id": "honeyfile-" + event['detail']['sourceIPAddress'],
                  "ProductArn": "arn:aws:securityhub:us-east-1:" + acctId + ":product/" + acctId + "/default",
                  "Resources": [
                          {
                              "Id": "arn:aws:s3:::" + event['detail']['requestParameters']['bucketName'] + "/" + event['detail']['requestParameters']['key'],
                              "Partition": "aws",
                              "Region": "us-east-1",
                              "Type" : "AwsS3Bucket"
                          }
                      ],
                  "Network": {
                          "Direction": "IN",
                          ipver: event['detail']['sourceIPAddress']
                      },
                  "SchemaVersion": "2018-10-08",
                  "Title": "Honey file used",
                  "UpdatedAt": event['detail']['eventTime'],
                  "UserDefinedFields": {
                      "userName": event['detail']['userIdentity']['userName'],
                      "eventName": event['detail']['eventName']
                  },
                  "Types": [
                          "Effects/Data Exfiltration",
                          "TTPs/Collection",
                          "Unusual Behaviors/User"
                      ],
                  "Severity": {
                      "Label": "CRITICAL",
                      "Original": "CRITICAL"
                      }
                  }]
                  )
              return {
                  'statusCode': 200,
                  'body': "Success!"
              }
      Handler: index.lambda_handler
      Runtime: python3.9
      Role: !GetAtt LambdaRole.Arn
  SensitiveBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Join
        - ''
        - - 'databackup-'
          - !Ref 'AWS::AccountId'
